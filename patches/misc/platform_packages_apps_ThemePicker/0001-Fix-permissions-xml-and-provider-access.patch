From 1dc2561b2f0a182a7b2e0e0a8c8e40425fec058e Mon Sep 17 00:00:00 2001
From: Huy Hoang <boydaihungst@gmail.com>
Date: Tue, 24 Oct 2023 22:32:40 +0700
Subject: [PATCH] Fix-permissions-xml-and-provider-access

Change-Id: I7d27fe3fb43e127b8c10d96929fc89555a03213d
---
 Android.bp                        |  9 +++++++++
 AndroidManifest.xml               | 12 +++++++++++-
 android.software.theme_picker.xml | 28 ++++++++++++++++++++++++++++
 3 files changed, 48 insertions(+), 1 deletion(-)
 create mode 100644 android.software.theme_picker.xml

diff --git a/Android.bp b/Android.bp
index f6c85581..7c77533e 100644
--- a/Android.bp
+++ b/Android.bp
@@ -94,6 +94,8 @@ java_defaults {
         ":ThemePicker_src_overrides",
     ],
 
+    required: ["android.software.theme_picker.xml"],
+
     use_embedded_native_libs: true,
 
     resource_zips: [":WallpaperPicker2_res", ":ThemePicker_res", ":ThemePicker_res_overrides"],
@@ -108,6 +110,13 @@ java_defaults {
     system_ext_specific: true,
 }
 
+prebuilt_etc {
+    name: "android.software.theme_picker.xml",
+    system_ext_specific: true,
+    sub_dir: "permissions",
+    src: "android.software.theme_picker.xml",
+}
+
 //
 // Build app code.
 //
diff --git a/AndroidManifest.xml b/AndroidManifest.xml
index 4e71bcc6..8ddf6cb2 100755
--- a/AndroidManifest.xml
+++ b/AndroidManifest.xml
@@ -11,9 +11,16 @@
     <uses-permission android:name="android.permission.READ_DEVICE_CONFIG" />
     <uses-permission android:name="android.permission.MODIFY_DAY_NIGHT_MODE" />
     <uses-permission android:name="android.permission.CUSTOMIZE_SYSTEM_UI" />
+    <uses-permission android:name="android.permission.BIND_WALLPAPER"/>
+    <uses-permission android:name="android.permission.READ_MEDIA_IMAGES"/>
+    <uses-permission android:name="android.permission.READ_WALLPAPER_INTERNAL"/>
+    <uses-permission android:name="android.permission.SET_WALLPAPER"/>
 
     <queries>
-        <!-- Specific intents Wallpaper picker query for -->
+        <package android:name="android"/>
+        <package android:name="com.android.launcher3"/>
+        <package android:name="com.android.settings"/>
+        <package android:name="com.android.systemui"/>        <!-- Specific intents Wallpaper picker query for -->
         <!-- Package for theme stub -->
         <package android:name="com.android.customization.themes" />
         <!-- Intent filter with action SET_WALLPAPER -->
@@ -45,6 +52,9 @@
         </intent>
     </queries>
 
+    <uses-permission android:name="com.android.launcher3.permission.READ_SETTINGS" />
+    <uses-permission android:name="com.android.launcher3.permission.WRITE_SETTINGS" />
+
     <application
         tools:replace="android:icon,android:name"
         android:extractNativeLibs="false"
diff --git a/android.software.theme_picker.xml b/android.software.theme_picker.xml
new file mode 100644
index 00000000..95d49f40
--- /dev/null
+++ b/android.software.theme_picker.xml
@@ -0,0 +1,28 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!-- Copyright (C) 2023 The Android Open Source Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<permissions>
+    <privapp-permissions package="com.android.wallpaper">
+        <permission name="android.permission.BIND_WALLPAPER"/>
+        <permission name="android.permission.CHANGE_OVERLAY_PACKAGES"/>
+        <permission name="android.permission.CUSTOMIZE_SYSTEM_UI"/>
+        <permission name="android.permission.MODIFY_DAY_NIGHT_MODE"/>
+        <permission name="android.permission.READ_DEVICE_CONFIG"/>
+        <permission name="android.permission.READ_WALLPAPER_INTERNAL"/>
+        <permission name="android.permission.SET_WALLPAPER"/>
+        <permission name="android.permission.SET_WALLPAPER_COMPONENT"/>
+        <permission name="android.permission.WRITE_SECURE_SETTINGS"/>
+    </privapp-permissions>
+</permissions>
-- 
2.42.0

